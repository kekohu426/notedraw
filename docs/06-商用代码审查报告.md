# NoteDraw 商用前代码审查报告

**审查日期**: 2025-12-22
**审查范围**: 全部核心代码
**严重程度分级**:
- P0 (致命): 必须立即修复，阻止上线
- P1 (严重): 上线前必须修复
- P2 (中等): 建议修复，可在上线后处理
- P3 (轻微): 代码质量问题，可选修复

---

## 一、安全问题 (Security Issues)

### P0 - 致命问题

#### 1. SQL注入风险 - 管理员搜索功能
**文件**: [admin-credits.ts:158-165](src/actions/admin-credits.ts#L158-L165)
```typescript
if (search) {
  query = query.where(
    or(
      like(user.name, `%${search}%`),
      like(user.email, `%${search}%`)
    )
  ) as typeof query;
}
```
**问题**: 虽然使用了Drizzle ORM的like函数，但直接拼接用户输入可能存在风险。
**建议**: 确认Drizzle ORM是否自动转义特殊字符，或使用参数化查询。

### P1 - 严重问题

#### 2. 管理员权限绕过风险
**文件**: [safe-action.ts:40-51](src/lib/safe-action.ts#L40-L51)
```typescript
export const adminActionClient = userActionClient.use(async ({ next, ctx }) => {
  const user = (ctx as { user: User }).user;
  const isDemo = isDemoWebsite();
  const isAdmin = user.role === 'admin';

  // If this is a demo website and user is not an admin, allow the request
  if (!isAdmin && !isDemo) {
    throw new Error('Unauthorized');
  }

  return next({ ctx });
});
```
**问题**: Demo模式下所有用户都有管理员权限，如果`NEXT_PUBLIC_DEMO_WEBSITE`被意外设置为true，将导致严重安全问题。
**建议**:
1. 在生产环境部署时确保此变量为false
2. 添加额外检查防止误配置

#### 3. API密钥暴露风险
**文件**: [painter.ts](src/ai/notedraw/painter.ts) 多处
```typescript
console.log('createImageTask response:', response);
console.log('Gemini response:', response);
```
**问题**: 生产环境中console.log可能泄露API响应细节。
**建议**: 使用条件日志或移除敏感日志。

#### 4. 认证Cookie检查不完整
**文件**: [middleware.ts:58-62](src/middleware.ts#L58-L62)
```typescript
const sessionToken =
  req.cookies.get('better-auth.session_token') ||
  req.cookies.get('__Secure-better-auth.session_token');

const isLoggedIn = !!sessionToken;
```
**问题**: 仅检查cookie存在，未验证token有效性。恶意用户可伪造cookie绕过路由保护。
**说明**: 注释中说明这是乐观检查，实际验证在页面中进行，但仍存在风险。

#### 5. 积分消费未使用事务
**文件**: [credits.ts:195-279](src/credits/credits.ts#L195-L279)
```typescript
export async function consumeCredits({...}) {
  // 检查余额
  if (!(await hasEnoughCredits({ userId, requiredCredits: amount }))) {...}
  // FIFO消费
  for (const transaction of transactions) {...}
  // 更新余额
  await db.update(userCredit)...
}
```
**问题**: 余额检查和扣减不在同一事务中，存在竞态条件。用户可能同时发起多个请求，导致积分透支。
**建议**: 使用数据库事务包装整个操作。

### P2 - 中等问题

#### 6. 硬编码的API地址
**文件**: [painter.ts:46-47](src/ai/notedraw/painter.ts#L46-L47)
```typescript
const GEMINI_IMAGE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
```
**建议**: 移至环境变量。

#### 7. 敏感信息日志
**文件**: [auth.ts:183-185](src/lib/auth.ts#L183-L185)
```typescript
console.log(`User ${user.email} subscribed to newsletter`);
```
**问题**: 日志中包含用户邮箱。
**建议**: 使用用户ID代替邮箱。

---

## 二、代码质量问题 (Code Quality)

### P1 - 严重

#### 8. 废弃代码未清理
**文件**: [organizer.ts:327-351](src/ai/notedraw/organizer.ts#L327-L351)
```typescript
// Deprecated functions still present
export function shouldSplitText(text: string): boolean {...}
export function splitTextByPoints(text: string): string[] {...}
```
**建议**: 删除未使用的废弃函数。

**文件**: [prompts.ts:124-134](src/ai/notedraw/prompts.ts#L124-L134)
同样存在废弃函数。

#### 9. 占位符代码残留
**文件**: [index.ts:55](src/ai/notedraw/index.ts#L55)
```typescript
const USE_PLACEHOLDER_IMAGE = false;
```
**问题**: 开发调试代码不应存在于生产代码中。
**建议**: 移除或使用环境变量控制。

#### 10. 类型断言滥用
**文件**: [index.ts:159](src/ai/notedraw/index.ts#L159)
```typescript
(unit as { negativePrompt?: string }).negativePrompt
```
**文件**: [plaza.ts:313](src/actions/plaza.ts#L313)
```typescript
const currentUser = (ctx as { user: User }).user;
```
**建议**: 使用类型守卫或泛型改进类型安全。

### P2 - 中等

#### 11. 错误处理不一致
多个文件中错误处理模式不一致：
- 有些返回 `{ success: false, error: message }`
- 有些抛出异常
- 有些返回null

**建议**: 统一错误处理模式。

#### 12. 重复代码
**文件**: [credits.ts](src/credits/credits.ts) 多处
```typescript
// 类似的检查和更新逻辑在多个函数中重复
if (current.length > 0) {
  await db.update(userCredit).set({...})
} else {
  await db.insert(userCredit).values({...})
}
```
**建议**: 抽取为公共函数。

#### 13. N+1查询问题
**文件**: [plaza.ts:109-131](src/actions/plaza.ts#L109-L131)
```typescript
const notesWithCovers = await Promise.all(
  notes.map(async (note) => {
    const cards = await db.select()...
  })
);
```
**问题**: 每个笔记单独查询封面图，导致N+1查询。
**建议**: 使用JOIN或批量查询。

---

## 三、潜在Bug (Potential Bugs)

### P1 - 严重

#### 14. 文本长度检查错误
**文件**: [organizer.ts:269-271](src/ai/notedraw/organizer.ts#L269-L271)
```typescript
const text = inputText.trim();
// 后续使用 inputText.length 而非 text.length
```
**问题**: trim后的长度检查可能不准确。

#### 15. ID碰撞风险
**文件**: [index.ts:136-137](src/ai/notedraw/index.ts#L136-L137)
```typescript
id: `${Date.now()}-${index}`,
```
**问题**: 快速循环中Date.now()可能返回相同值。
**建议**: 使用nanoid或UUID。

### P2 - 中等

#### 16. 空值处理不完整
**文件**: [stripe.ts:423](src/payment/provider/stripe.ts#L423)
```typescript
public async getCheckoutSession(sessionId: string): Promise<any | null> {
```
**问题**: 返回类型为any，缺乏类型安全。

#### 17. 配置回退值缺失
**文件**: [website.tsx:112](src/config/website.tsx#L112)
```typescript
priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY!,
```
**问题**: 使用非空断言，但环境变量可能未设置。
**建议**: 添加默认值或启动时验证。

---

## 四、性能问题 (Performance)

### P2 - 中等

#### 18. 顺序API调用
**文件**: [painter.ts:554-570](src/ai/notedraw/painter.ts#L554-L570)
```typescript
export async function paintBatch(...) {
  // 顺序处理而非并发
}
```
**建议**: 使用Promise.all或p-limit控制并发。

#### 19. 未优化的数据库查询
**文件**: [plaza.ts:261-270](src/actions/plaza.ts#L261-L270)
```typescript
// 获取所有公开笔记的标签，然后在内存中统计
const notes = await db.select({ tags: noteProject.tags })...
```
**建议**: 使用GROUP BY在数据库层面统计。

---

## 五、配置安全 (Configuration Security)

### P1 - 严重

#### 20. 环境变量暴露风险
**文件**: .env.local
```
BETTER_AUTH_SECRET="random_secret_string_for_dev_environment"
```
**问题**: 使用弱密钥。
**建议**: 生产环境使用强随机密钥（至少32字符）。

#### 21. 默认邮件配置
**文件**: [website.tsx:79-80](src/config/website.tsx#L79-L80)
```typescript
fromEmail: 'NoteDraw <onboarding@resend.dev>',
supportEmail: 'NoteDraw <onboarding@resend.dev>',
```
**问题**: 使用Resend的测试域名。
**建议**: 上线前配置正式域名邮箱。

---

## 六、必须修复清单 (上线前)

### 优先级 P0 (阻塞上线)
- [ ] 无致命问题

### 优先级 P1 (必须修复)
1. [ ] 移除或保护Demo模式管理员权限绕过
2. [ ] 移除生产环境敏感日志
3. [ ] 积分消费添加数据库事务
4. [ ] 生成强随机的BETTER_AUTH_SECRET
5. [ ] 配置正式邮件域名
6. [ ] 清理废弃代码和占位符

### 优先级 P2 (建议修复)
7. [ ] 修复N+1查询问题
8. [ ] 统一错误处理模式
9. [ ] 移除类型断言，使用类型守卫
10. [ ] 环境变量添加默认值或验证

---

## 七、代码亮点 (Positive Findings)

1. **良好的支付架构**: Stripe/Creem双提供商设计，易于扩展
2. **完整的Webhook处理**: 包含重试机制和幂等性处理
3. **国际化支持**: next-intl集成完善
4. **积分FIFO消费**: 过期优先消费逻辑正确
5. **中间件路由保护**: 基本的路由保护机制到位
6. **类型定义完整**: Zod schema验证覆盖良好

---

## 八、总结

| 类别 | P0 | P1 | P2 | P3 |
|------|----|----|----|----|
| 安全问题 | 0 | 5 | 2 | 0 |
| 代码质量 | 0 | 3 | 3 | 0 |
| 潜在Bug | 0 | 2 | 2 | 0 |
| 性能问题 | 0 | 0 | 2 | 0 |
| 配置安全 | 0 | 2 | 0 | 0 |
| **总计** | **0** | **12** | **9** | **0** |

**结论**: 代码整体质量良好，无阻塞上线的致命问题。但存在12个P1级别问题需要在上线前修复，主要集中在安全和配置方面。建议按照上述清单逐项修复后再进行商用部署。
