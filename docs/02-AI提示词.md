# NoteDraw AI 提示词文档

## 一、AI架构概览

NoteDraw采用三层AI架构：

```
用户输入文本
    ↓
┌─────────────────────────────────────┐
│  Organizer（拆解Agent）             │
│  - 模型：GLM-4-Flash               │
│  - 功能：分析文本，提取知识点        │
│  - 输出：结构化数据 LeftBrainData   │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Designer（Prompt构建Agent）        │
│  - 功能：将结构化数据转为绘图Prompt  │
│  - 输出：完整绘图指令 RightBrainData │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  Painter（生图Agent）               │
│  - 模型：Gemini-3-Pro / GPT-4o-image│
│  - 功能：生成视觉笔记图片           │
│  - 输出：图片URL                    │
└─────────────────────────────────────┘
```

---

## 二、Organizer 拆解Agent 提示词

### 2.1 系统提示词（中文版）

```
你是一位视觉笔记架构师，专精于将长文转化为结构化的视觉笔记。

【详细模式】根据知识点数量决定卡片数量：≤4个知识点=1张图，>4个知识点=多张图（每张≤4个Section）

## 分析步骤

1. **知识点提取**：阅读全文，识别所有核心知识点
2. **数量决策**：统计知识点数量，决定生成几张卡片
3. **内容重组**：将原文重组为多个完整短句，用分号分隔
4. **结构输出**：按格式输出JSON

## 输出规则（视觉笔记专家标准）

- 每张卡片最多4个Section

**【视觉笔记三要素】**

1. **heading（标题）**：≤8字，精炼概括
   - ✅ "RAG检索增强"、"V2EX引流"
   - ❌ "关于如何使用RAG技术进行检索增强的方法"

2. **keywords（关键短语）**：2-3个可理解的短语，每个5-10字
   - 这是图片上显示的核心内容！
   - 必须是"能看懂"的短语，不是单词
   - ✅ ["检索相关文档", "增强上下文", "生成准确回答"]
   - ❌ ["检索", "增强", "生成"]

3. **summary（详细说明）**：30-50字，2-3个完整句子
   - 用于编辑时参考，不会显示在图片上
   - ✅ "先从知识库检索相关文档；然后将文档作为上下文增强提示词；最后生成更准确的回答。"

## 待分析文本
"""
${text}
"""

## 返回格式（严格JSON）

**重要提示**：所有 heading、keywords 和 summary 都必须使用中文。

示例格式：

```json
{
  "totalKnowledgePoints": 4,
  "cards": [
    {
      "cardIndex": 1,
      "cardTitle": "RAG检索增强生成",
      "sections": [
        {
          "heading": "检索阶段",
          "keywords": ["从知识库检索文档", "匹配用户问题", "返回相关片段"],
          "summary": "先根据用户问题从知识库中检索相关文档；通过语义匹配找到最相关的内容片段。"
        },
        {
          "heading": "增强阶段",
          "keywords": ["文档作为上下文", "增强提示词", "提供背景信息"],
          "summary": "将检索到的文档作为上下文加入提示词；为模型提供准确的背景信息参考。"
        },
        {
          "heading": "生成阶段",
          "keywords": ["基于上下文生成", "回答更准确", "减少幻觉"],
          "summary": "模型基于增强后的上下文生成回答；有了真实资料支撑，回答更准确可靠。"
        }
      ]
    }
  ]
}
```

只返回JSON，不要任何解释或markdown代码块标记。
```

### 2.2 系统提示词（英文版）

```
You are a Visual Note Architect, expert at transforming long text into structured visual notes.

[DETAILED MODE] Decide card count by knowledge points: ≤4 points=1 card, >4 points=multiple cards (each ≤4 sections)

## Analysis Steps

1. **Extract Knowledge Points**: Read the text, identify all core points
2. **Quantity Decision**: Count points, decide how many cards to generate
3. **Content Restructure**: Reorganize into complete short sentences, separated by semicolons
4. **Structured Output**: Output JSON in the required format

## Output Rules (Visual Note Expert Standard)

- Max 4 sections per card

**[Visual Note Three Elements]**

1. **heading (title)**: ≤8 words, concise summary
   - ✅ "RAG Retrieval", "V2EX Traffic"
   - ❌ "How to use RAG technology for retrieval augmentation methods"

2. **keywords (key phrases)**: 2-3 understandable phrases, each 5-10 words
   - This is the core content displayed on the image!
   - Must be "understandable" phrases, not single words
   - ✅ ["Retrieve relevant docs", "Enhance context", "Generate accurate answer"]
   - ❌ ["Retrieve", "Enhance", "Generate"]

3. **summary (detailed description)**: 30-50 chars, 2-3 complete sentences
   - For reference during editing, NOT displayed on the image
   - ✅ "First retrieve relevant docs from knowledge base; then enhance prompt with docs as context; finally generate more accurate answers."

## Text to Analyze
"""
${text}
"""

## Response Format (strict JSON)

**IMPORTANT**: All heading, keywords, and summary MUST be in English.

Example format:

```json
{
  "totalKnowledgePoints": 4,
  "cards": [
    {
      "cardIndex": 1,
      "cardTitle": "RAG Retrieval Augmented Generation",
      "sections": [
        {
          "heading": "Retrieval Stage",
          "keywords": ["Retrieve docs from knowledge base", "Match user query", "Return relevant chunks"],
          "summary": "First retrieve relevant documents from knowledge base based on user query; find most relevant content chunks through semantic matching."
        },
        {
          "heading": "Enhancement Stage",
          "keywords": ["Docs as context", "Enhance prompt", "Provide background info"],
          "summary": "Add retrieved documents as context to prompt; provide accurate background information for the model."
        },
        {
          "heading": "Generation Stage",
          "keywords": ["Generate from context", "More accurate answers", "Reduce hallucinations"],
          "summary": "Model generates answers based on enhanced context; with real data support, answers are more accurate and reliable."
        }
      ]
    }
  ]
}
```

Return ONLY the JSON, no explanations or markdown code blocks.
```

### 2.3 精简模式提示词差异

精简模式时，在系统提示词开头增加：
```
【强制要求】用户选择了精简模式，你必须只生成1张卡片，最多4个知识点。选择最重要的内容。
```

英文版：
```
[STRICT] User selected compact mode. You MUST output only 1 card with max 4 sections. Pick the most important content.
```

---

## 三、Designer Prompt构建Agent

### 3.1 详细模式图像Prompt模板

```
A cute hand-drawn notebook style infographic showing "${structure.title}".

Main title: "${structure.title}"

${sectionCount} main sections with cute icons:

Section 1: "${module.heading}"
Icon: A cute hand-drawn icon representing "${module.heading}"
Text labels: "${keywords[0]}", "${keywords[1]}", "${keywords[2]}"

Section 2: "${module.heading}"
Icon: A cute hand-drawn icon representing "${module.heading}"
Text labels: "${keywords[0]}", "${keywords[1]}", "${keywords[2]}"

... (更多sections)

Center connecting element: "${structure.summary_context}" with flowing arrows connecting all sections

Bottom right corner: "${signature}"

Style: ${styleConfig.promptKeywords}
Color palette: ${styleConfig.colorPalette}

Design requirements:
- Hand-drawn sketchy lines with warm, personal feel
- Clear visual hierarchy with the title at top
- Each section has its own cute icon and section title
- Display the text labels clearly in each section (readable short phrases)
- Text in speech bubbles or text boxes with clean handwritten font
- Balanced layout: icons + text labels, not too crowded
- Clean and easy to scan at a glance
- Aspect ratio: 3:4 (portrait, suitable for mobile)
- Theme: ${structure.visual_theme_keywords}
```

### 3.2 精简模式图像Prompt模板

```
A cute hand-drawn visual note card about "${structure.title}".

Central focus: ${structure.summary_context}

Key points displayed with cute icons:
"${keyword1}", "${keyword2}", "${keyword3}", "${keyword4}", "${keyword5}", "${keyword6}"

Bottom right corner: "${signature}"

Style: ${styleConfig.promptKeywords}
Colors: ${styleConfig.colorPalette}

Requirements:
- Single cohesive illustration
- Hand-drawn aesthetic with warm colors
- Clear, readable text labels
- Aspect ratio: 3:4
```

---

## 四、视觉风格配置

### 4.1 风格定义

#### sketch（手绘清新）
```javascript
{
  promptKeywords: 'hand-drawn style, marker pen illustration, soft pastel colors, cute doodles, warm and friendly, sketch notes style, whiteboard illustration',
  colorPalette: 'soft pastels, warm tones, mint green, coral pink, light blue',
  negativePrompt: 'photorealistic, 3D render, dark colors, complex gradients',
}
```

#### business（商务专业）
```javascript
{
  promptKeywords: 'professional infographic, clean minimal design, corporate style, navy blue and white, icon-based, data visualization, business presentation',
  colorPalette: 'navy blue, white, light gray, accent gold',
  negativePrompt: 'cartoon, childish, hand-drawn, messy',
}
```

#### cute（可爱插画）
```javascript
{
  promptKeywords: 'kawaii style, cute cartoon illustration, rainbow colors, sticker art, chibi characters, playful design, social media friendly',
  colorPalette: 'rainbow colors, pink, yellow, light purple, bright and cheerful',
  negativePrompt: 'realistic, dark, serious, corporate',
}
```

#### minimal（极简线稿）
```javascript
{
  promptKeywords: 'minimalist line art, black and white, geometric shapes, lots of white space, clean typography, modern design, abstract',
  colorPalette: 'black, white, light gray',
  negativePrompt: 'colorful, detailed, complex, busy',
}
```

#### chalkboard（复古黑板）
```javascript
{
  promptKeywords: 'chalkboard style, chalk drawing, blackboard background, hand-written text, educational, vintage classroom, teacher notes',
  colorPalette: 'dark green or black background, white and colored chalk',
  negativePrompt: 'digital, modern, clean lines, bright colors',
}
```

### 4.2 通用Negative Prompt

```
${styleConfig.negativePrompt}, blurry, low quality, distorted text, watermark, multiple frames, comic panels, photo-realistic
```

---

## 五、数据结构定义

### 5.1 LeftBrainData（结构化分析结果）

```typescript
interface LeftBrainData {
  title: string;                    // 笔记标题
  summary_context: string;          // 内容概要
  visual_theme_keywords: string;    // 视觉主题关键词
  modules: ContentModule[];         // 知识模块列表
}

interface ContentModule {
  id: string;           // 模块ID
  heading: string;      // 标题（≤8字）
  content: string;      // 详细内容（30-50字）
  keywords?: string[];  // 关键短语（2-3个）
}
```

### 5.2 RightBrainData（绘图指令）

```typescript
interface RightBrainData {
  prompt: string;           // 主Prompt
  negativePrompt?: string;  // Negative Prompt
}
```

---

## 六、API调用配置

### 6.1 GLM-4-Flash（文本分析）

```javascript
{
  model: 'glm-4-flash',
  temperature: 0.1,  // 低温度确保输出稳定
  messages: [{ role: 'user', content: prompt }],
}
```

**API端点**：`${GLM_BASE_URL}/chat/completions`
**默认Base URL**：`https://open.bigmodel.cn/api/paas/v4`

### 6.2 Gemini-3-Pro-Image（图像生成）

```javascript
{
  model: 'gemini-3-pro-image-preview',
  contents: [{ parts: [{ text: prompt }] }],
  generationConfig: {
    responseModalities: ['TEXT', 'IMAGE']
  }
}
```

**API端点**：`${GEMINI_IMAGE_BASE_URL}/models/${model}:generateContent`
**默认Base URL**：`https://api.nanobananai.com/v1beta`

### 6.3 GPT-4o-Image（备选图像生成）

```javascript
{
  model: 'gpt-4o-image',
  prompt: prompt,
  size: aspectRatio,  // 如 '3:4'
  n: 1,
}
```

**API端点**：`${OPENAI_BASE_URL}/images/generations`
**任务查询**：`${OPENAI_BASE_URL}/tasks/${taskId}`

---

## 七、轮询策略

### 7.1 指数退避参数

```javascript
const INITIAL_POLL_INTERVAL = 1000;  // 初始1秒
const MAX_POLL_INTERVAL = 5000;      // 最大5秒
const MAX_POLL_ATTEMPTS = 30;        // 最多30次（约1分钟）

function getPollInterval(attempt: number): number {
  const interval = INITIAL_POLL_INTERVAL * Math.pow(1.3, attempt);
  return Math.min(interval, MAX_POLL_INTERVAL);
}
```

### 7.2 轮询间隔序列

| 次数 | 间隔(ms) |
|------|----------|
| 1 | 1000 |
| 2 | 1300 |
| 3 | 1690 |
| 4 | 2197 |
| 5 | 2856 |
| 6 | 3713 |
| 7 | 4826 |
| 8+ | 5000 |

---

## 八、错误处理

### 8.1 Organizer错误处理

当分析失败时，返回fallback结构：

```javascript
{
  totalKnowledgePoints: 0,
  structures: [{
    title: '分析失败',
    summary_context: '请重试或简化输入内容',
    visual_theme_keywords: 'error, retry',
    modules: [{
      id: '1',
      heading: '错误信息',
      content: error.message,
      keywords: [],
    }],
  }],
  rawAnalysis: null,
}
```

### 8.2 Painter错误处理

- 最大重试次数：2次
- 每次重试间隔：1000ms * (attempt + 1)
- 超时处理：30次轮询后返回超时错误

---

## 九、提示词优化建议

### 9.1 视觉一致性
- 每种风格都有明确的promptKeywords和colorPalette
- negativePrompt排除不符合风格的元素
- 保持3:4的竖版比例，适合手机浏览

### 9.2 文字可读性
- 使用"Text labels"而非"Text"强调文字需要清晰可读
- 在speech bubbles或text boxes中放置文字
- 使用handwritten font风格

### 9.3 结构清晰
- 每张卡片最多4个Section
- 每个Section有独立的icon和heading
- 用arrows连接各个部分

### 9.4 国际化
- 根据language参数切换提示词语言
- 中文版强调"中文"输出
- 英文版强调"English"输出
