# NoteDraw 业务描述文档

## 一、产品概述

**产品名称**：NoteDraw（视觉笔记生成器）

**产品定位**：AI驱动的视觉笔记生成SaaS平台，将长文本自动转换为精美的手绘风格视觉笔记卡片。

**核心价值**：
- 将复杂文本内容结构化
- 自动生成可分享的视觉笔记图片
- 支持多种风格和语言
- 适用于学习笔记、知识总结、内容创作

---

## 二、用户端功能

### 2.1 核心生成功能

#### 2.1.1 内容输入方式
| 方式 | 说明 | 限制 |
|------|------|------|
| 文本输入 | 直接输入或粘贴文字 | 10-10000字符 |
| URL导入 | 从网页提取正文内容 | 最大10000字符 |
| 文件上传 | 支持PDF、Word等文件 | 待完善 |

#### 2.1.2 生成模式
| 模式 | 说明 | 输出 |
|------|------|------|
| 精简模式(compact) | 快速生成，适合简短内容 | 1张卡片 |
| 详细模式(detailed) | 完整分析，适合长文本 | 多张卡片（每张≤4个Section） |

#### 2.1.3 视觉风格（5种）
| 风格ID | 中文名 | 英文名 | 描述 |
|--------|--------|--------|------|
| sketch | 手绘清新 | Hand-drawn Sketch | 马克笔手绘风格，柔和配色，涂鸦元素 |
| business | 商务专业 | Professional Business | 简洁线条，深蓝配色，图标化设计 |
| cute | 可爱插画 | Cute Illustration | 卡通人物，彩虹配色，贴纸感 |
| minimal | 极简线稿 | Minimal Line Art | 黑白线条，几何形状，大量留白 |
| chalkboard | 复古黑板 | Vintage Chalkboard | 黑板背景，粉笔字，手写风格 |

#### 2.1.4 其他配置
- **语言选择**：中文(zh) / 英文(en) - 控制生成图片上的文字语言
- **署名配置**：显示在图片右下角的署名文字，默认"娇姐手绘整理"

### 2.2 结果展示与操作

#### 生成结果
- 卡片列表展示：显示所有生成的视觉笔记卡片
- 图片预览：点击放大查看
- 下载功能：保存单张或批量下载

#### 编辑功能
- **重新生成**：使用原有参数重新生成某张卡片
- **自定义Prompt**：用户可编辑Prompt后重新生成
- **查看Prompt**：查看AI生成使用的完整Prompt

### 2.3 历史记录
- 查看所有生成项目
- 按时间排序
- 项目详情查看
- 删除项目

### 2.4 广场功能（Plaza）

#### 用户操作
- **分享到广场**：将完成的项目分享到公共广场
  - 设置标题（1-100字符）
  - 设置描述（最多500字符）
  - 设置标签（逗号分隔）
- **从广场移除**：撤回已分享的内容

#### 浏览功能
- 查看公开的视觉笔记
- 按风格筛选
- 按标签筛选
- 查看热门标签
- 浏览量统计

### 2.5 兑换码功能
- 输入兑换码获取积分
- 查看兑换记录

### 2.6 账户设置
- 个人资料管理
- 安全设置（密码修改）
- 积分余额查看
- 交易记录查看
- 订阅管理
- 账单查看

---

## 三、管理端功能

### 3.1 管理后台入口
- 路径：`/admin`
- 权限：仅 `role = 'admin'` 的用户可访问

### 3.2 仪表盘（Dashboard）
- 系统统计概览
- 用户数量
- 项目数量
- 收入统计

### 3.3 用户管理
- 用户列表查看
- 用户详情
- 禁止/解禁用户
- 角色管理（设为admin）
- 模拟登录（impersonate）

### 3.4 广场管理
- 查看所有公开笔记
- 设置/取消精选（Featured）
- 强制下架笔记

### 3.5 兑换码管理
- **创建兑换码**（批量）
  - 类型：credits（积分）/ membership（会员）/ trial（试用）
  - 数值：积分数量或天数
  - 最大使用次数
  - 过期时间
  - 批量生成数量（1-100）
- **查看兑换码列表**
- **编辑兑换码状态**
  - 启用/禁用
  - 修改使用次数
  - 修改过期时间
- **查看使用记录**

### 3.6 积分管理
- 积分统计
- 手动调整用户积分
- 交易记录查看

### 3.7 订单管理
- 支付订单列表
- 订单状态查看

### 3.8 内容管理
- 博客文章管理
- 系统配置管理

---

## 四、业务逻辑流程

### 4.1 核心生成流程

```
用户输入文本
    ↓
[createProjectAction] 创建项目
    - 验证用户身份
    - 验证输入长度
    - 保存项目到数据库
    - 返回 projectId
    ↓
[generateNotesAction] 生成笔记
    - 检查积分余额
    - 更新项目状态为 processing
    ↓
[Organizer] 拆解Agent - 文本分析
    - 调用 GLM-4-Flash API
    - 提取知识点
    - 决定卡片数量
    - 输出结构化数据 (LeftBrainData)
    ↓
[Designer] Prompt构建Agent
    - 根据结构化数据生成Prompt
    - 应用风格配置
    - 添加署名
    ↓
[Painter] 生图Agent
    - 调用图像生成API（Gemini/GPT-4o-image）
    - 支持多种provider
    - 并行生成（并发数=2）
    - 轮询任务状态（指数退避）
    ↓
保存卡片到数据库
    ↓
扣除积分
    - 分析积分：1次
    - 图片积分：每张 × 5
    ↓
返回生成结果
```

### 4.2 积分消耗规则

| 操作 | 积分消耗 |
|------|----------|
| 内容分析 | 1 积分/次 |
| 图片生成 | 5 积分/张 |
| 图片重新生成 | 5 积分/张 |

### 4.3 积分获取方式

| 来源 | 积分数量 | 有效期 |
|------|----------|--------|
| 注册赠送 | 50 | 30天 |
| 免费计划月度刷新 | 50 | 30天 |
| Pro订阅月度刷新 | 1000 | 30天 |
| 积分包购买 | 100-1000 | 30天 |
| 兑换码 | 自定义 | 自定义 |

---

## 五、后端API清单

### 5.1 Server Actions（核心业务）

#### NoteDraw相关 (`src/actions/notedraw.ts`)
| Action | 说明 | 权限 |
|--------|------|------|
| createProjectAction | 创建项目 | 登录用户 |
| generateNotesAction | 生成笔记 | 登录用户 |
| regenerateCardAction | 重新生成卡片 | 登录用户 |
| regenerateWithPromptAction | 自定义Prompt重新生成 | 登录用户 |
| getProjectAction | 获取项目详情 | 登录用户 |
| getUserProjectsAction | 获取用户所有项目 | 登录用户 |
| deleteProjectAction | 删除项目 | 登录用户 |
| fetchUrlContentAction | 从URL获取内容 | 登录用户 |

#### 广场相关 (`src/actions/plaza.ts`)
| Action | 说明 | 权限 |
|--------|------|------|
| getPlazaNotesAction | 获取广场笔记列表 | 公开 |
| getNoteBySlugAction | 根据slug获取笔记 | 公开 |
| getPopularTagsAction | 获取热门标签 | 公开 |
| shareToPlazaAction | 分享到广场 | 登录用户 |
| removeFromPlazaAction | 从广场移除 | 登录用户 |
| setFeaturedAction | 设置精选 | 管理员 |
| adminRemoveNoteAction | 强制下架 | 管理员 |
| getAdminPlazaNotesAction | 管理员查看列表 | 管理员 |

#### 兑换码相关 (`src/actions/redemption.ts`)
| Action | 说明 | 权限 |
|--------|------|------|
| redeemCodeAction | 用户兑换码 | 登录用户 |
| getUserRedemptionsAction | 获取用户兑换记录 | 登录用户 |
| createRedemptionCodesAction | 批量创建兑换码 | 管理员 |
| getRedemptionCodesAction | 获取所有兑换码 | 管理员 |
| updateRedemptionCodeAction | 更新兑换码状态 | 管理员 |
| getCodeRedemptionsAction | 获取兑换码使用记录 | 管理员 |
| getAllRedemptionRecordsAction | 获取所有兑换记录 | 管理员 |

#### 其他Actions
| 文件 | 主要功能 |
|------|----------|
| create-checkout-session.ts | 创建支付会话 |
| create-credit-checkout-session.ts | 创建积分购买会话 |
| create-customer-portal-session.ts | 创建客户门户会话 |
| consume-credits.ts | 消耗积分 |
| get-credit-stats.ts | 获取积分统计 |
| get-credit-transactions.ts | 获取积分交易记录 |
| get-current-plan.ts | 获取当前订阅计划 |
| get-payments.ts | 获取支付记录 |
| get-users.ts | 获取用户列表（管理员） |
| admin-credits.ts | 管理员积分操作 |
| blog.ts | 博客相关 |
| gallery.ts | 画廊相关 |
| system-config.ts | 系统配置 |
| subscribe-newsletter.ts | 订阅Newsletter |
| unsubscribe-newsletter.ts | 退订Newsletter |

### 5.2 API Routes

| 路径 | 方法 | 说明 |
|------|------|------|
| /api/auth/[...all] | ALL | Better Auth 认证 |
| /api/webhooks/creem | POST | Creem支付Webhook |
| /api/ping | GET | 健康检查 |
| /api/chat | POST | AI聊天接口 |
| /api/analyze-content | POST | 内容分析 |
| /api/generate-images | POST | 图片生成 |
| /api/storage/upload | POST | 文件上传 |
| /api/search | GET | 搜索 |
| /api/distribute-credits | POST | 积分分发 |

---

## 六、页面路由结构

### 6.1 营销页面（Marketing）
```
/                           首页
/pricing                    价格页
/blog                       博客列表
/blog/[slug]                博客文章
/gallery                    作品画廊
/plaza                      作品广场
/plaza/notes/[slug]         广场笔记详情
/about                      关于我们
/contact                    联系我们
/waitlist                   等候列表
/changelog                  更新日志
/roadmap                    路线图
/privacy                    隐私政策
/terms                      服务条款
/cookie                     Cookie政策
/docs                       文档（可选启用）
```

### 6.2 认证页面（Auth）
```
/auth/login                 登录
/auth/register              注册
/auth/forgot-password       忘记密码
/auth/reset-password        重置密码
/auth/error                 认证错误
```

### 6.3 用户页面（Protected）
```
/dashboard                  用户仪表盘
/notedraw                   视觉笔记生成器
/notedraw/history           历史记录
/notedraw/[id]              项目详情
/settings/profile           个人资料
/settings/security          安全设置
/settings/credits           积分管理
/settings/billing           账单
/settings/notifications     通知设置
/payment                    支付页面
```

### 6.4 管理页面（Admin）
```
/admin                      管理后台首页
/admin/dashboard            管理仪表盘
/admin/users                用户管理
/admin/plaza                广场管理
/admin/redemption           兑换码管理
/admin/credits              积分管理
/admin/orders               订单管理
/admin/blog                 博客管理
/admin/content              内容管理
/admin/settings             系统设置
```

---

## 七、状态定义

### 7.1 项目状态（ProjectStatus）
| 状态 | 说明 |
|------|------|
| draft | 草稿，已创建未生成 |
| processing | 处理中 |
| completed | 已完成 |
| failed | 失败 |

### 7.2 卡片状态（CardStatus）
| 状态 | 说明 |
|------|------|
| pending | 待生成 |
| generating | 生成中 |
| completed | 已完成 |
| failed | 失败 |

### 7.3 支付状态
| 状态 | 说明 |
|------|------|
| pending | 待支付 |
| active | 有效 |
| canceled | 已取消 |
| expired | 已过期 |

---

## 八、关键业务规则

### 8.1 积分规则
1. 积分先消费先过期（FIFO）
2. 积分有过期时间，通常30天
3. 消费前检查余额，生成成功后扣除
4. 部分失败只扣成功部分

### 8.2 兑换码规则
1. 每个用户每个兑换码只能使用一次
2. 兑换码可设置最大使用次数
3. 兑换码可设置过期时间
4. 兑换码可随时禁用

### 8.3 广场规则
1. 只有已完成的项目可分享
2. 用户可随时撤回分享
3. 管理员可强制下架
4. 精选笔记优先展示

### 8.4 权限规则
1. 未登录用户：只能浏览公开内容
2. 登录用户：可使用生成功能
3. 管理员：可访问管理后台
