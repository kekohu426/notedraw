# NoteDraw 数据模型文档

## 一、数据库概览

**数据库**：PostgreSQL
**ORM**：Drizzle ORM
**表数量**：10张表

### 表清单

| 表名 | 说明 | 类型 |
|------|------|------|
| user | 用户表 | 脚手架 |
| session | 会话表 | 脚手架 |
| account | 账户表 | 脚手架 |
| verification | 验证表 | 脚手架 |
| payment | 支付表 | 脚手架 |
| user_credit | 用户积分表 | 脚手架 |
| credit_transaction | 积分交易表 | 脚手架 |
| note_project | 笔记项目表 | 业务 |
| note_card | 笔记卡片表 | 业务 |
| redemption_code | 兑换码表 | 业务 |
| redemption_record | 兑换记录表 | 业务 |

---

## 二、用户认证相关表

### 2.1 user（用户表）

```sql
CREATE TABLE "user" (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL UNIQUE,
  email_verified BOOLEAN NOT NULL,
  image TEXT,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  role TEXT,                    -- 'admin' | null
  banned BOOLEAN,               -- 是否被封禁
  ban_reason TEXT,              -- 封禁原因
  ban_expires TIMESTAMP,        -- 封禁过期时间
  customer_id TEXT              -- Stripe/Creem 客户ID
);

-- 索引
CREATE INDEX user_id_idx ON "user"(id);
CREATE INDEX user_customer_id_idx ON "user"(customer_id);
CREATE INDEX user_role_idx ON "user"(role);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 主键，UUID |
| name | TEXT | 用户名 |
| email | TEXT | 邮箱，唯一 |
| email_verified | BOOLEAN | 邮箱是否验证 |
| image | TEXT | 头像URL |
| role | TEXT | 角色：'admin' 或 null |
| banned | BOOLEAN | 是否被封禁 |
| ban_reason | TEXT | 封禁原因 |
| ban_expires | TIMESTAMP | 封禁过期时间 |
| customer_id | TEXT | 支付系统客户ID |

### 2.2 session（会话表）

```sql
CREATE TABLE "session" (
  id TEXT PRIMARY KEY,
  expires_at TIMESTAMP NOT NULL,
  token TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  ip_address TEXT,
  user_agent TEXT,
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  impersonated_by TEXT         -- 模拟登录的管理员ID
);

-- 索引
CREATE INDEX session_token_idx ON "session"(token);
CREATE INDEX session_user_id_idx ON "session"(user_id);
```

### 2.3 account（账户表）

```sql
CREATE TABLE "account" (
  id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL,     -- 第三方账户ID
  provider_id TEXT NOT NULL,    -- 提供商：google/github/credential
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  access_token TEXT,
  refresh_token TEXT,
  id_token TEXT,
  access_token_expires_at TIMESTAMP,
  refresh_token_expires_at TIMESTAMP,
  scope TEXT,
  password TEXT,                -- 密码登录时存储哈希
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);

-- 索引
CREATE INDEX account_user_id_idx ON "account"(user_id);
CREATE INDEX account_account_id_idx ON "account"(account_id);
CREATE INDEX account_provider_id_idx ON "account"(provider_id);
```

### 2.4 verification（验证表）

```sql
CREATE TABLE "verification" (
  id TEXT PRIMARY KEY,
  identifier TEXT NOT NULL,     -- 邮箱或其他标识
  value TEXT NOT NULL,          -- 验证码/token
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

---

## 三、支付相关表

### 3.1 payment（支付表）

```sql
CREATE TABLE "payment" (
  id TEXT PRIMARY KEY,
  price_id TEXT NOT NULL,        -- Stripe/Creem 价格ID
  type TEXT NOT NULL,            -- 支付类型：subscription/one_time
  scene TEXT,                    -- 支付场景：lifetime/credit/subscription
  interval TEXT,                 -- 订阅间隔：month/quarter/year
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  customer_id TEXT NOT NULL,     -- 客户ID
  subscription_id TEXT,          -- 订阅ID
  session_id TEXT,               -- 会话ID
  invoice_id TEXT UNIQUE,        -- 发票ID（避免重复处理）
  status TEXT NOT NULL,          -- 状态
  paid BOOLEAN NOT NULL DEFAULT FALSE,
  period_start TIMESTAMP,
  period_end TIMESTAMP,
  cancel_at_period_end BOOLEAN,
  trial_start TIMESTAMP,
  trial_end TIMESTAMP,
  provider TEXT NOT NULL DEFAULT 'stripe',  -- stripe/creem
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX payment_type_idx ON "payment"(type);
CREATE INDEX payment_scene_idx ON "payment"(scene);
CREATE INDEX payment_price_id_idx ON "payment"(price_id);
CREATE INDEX payment_user_id_idx ON "payment"(user_id);
CREATE INDEX payment_customer_id_idx ON "payment"(customer_id);
CREATE INDEX payment_status_idx ON "payment"(status);
CREATE INDEX payment_paid_idx ON "payment"(paid);
CREATE INDEX payment_subscription_id_idx ON "payment"(subscription_id);
CREATE INDEX payment_session_id_idx ON "payment"(session_id);
CREATE INDEX payment_invoice_id_idx ON "payment"(invoice_id);
```

| 字段 | 类型 | 说明 |
|------|------|------|
| type | TEXT | 'subscription' / 'one_time' |
| scene | TEXT | 'lifetime' / 'credit' / 'subscription' |
| interval | TEXT | 'month' / 'quarter' / 'year' |
| status | TEXT | 'pending' / 'active' / 'canceled' / 'expired' |
| provider | TEXT | 'stripe' / 'creem' |

---

## 四、积分相关表

### 4.1 user_credit（用户积分表）

```sql
CREATE TABLE "user_credit" (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  current_credits INTEGER NOT NULL DEFAULT 0,
  last_refresh_at TIMESTAMP,    -- 已废弃
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX user_credit_user_id_idx ON "user_credit"(user_id);
```

### 4.2 credit_transaction（积分交易表）

```sql
CREATE TABLE "credit_transaction" (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  type TEXT NOT NULL,            -- 交易类型
  description TEXT,              -- 描述
  amount INTEGER NOT NULL,       -- 金额（正=获得，负=消耗）
  remaining_amount INTEGER,      -- 剩余可消耗金额
  payment_id TEXT,               -- 关联支付ID
  expiration_date TIMESTAMP,     -- 过期时间
  expiration_date_processed_at TIMESTAMP,  -- 过期处理时间
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX credit_transaction_user_id_idx ON "credit_transaction"(user_id);
CREATE INDEX credit_transaction_type_idx ON "credit_transaction"(type);
```

**交易类型（type）枚举：**

```typescript
const CREDIT_TRANSACTION_TYPE = {
  USAGE: 'usage',                         // 使用消耗
  EXPIRE: 'expire',                       // 过期扣除
  REGISTER_GIFT: 'register_gift',         // 注册赠送
  MONTHLY_REFRESH: 'monthly_refresh',     // 免费计划月度刷新
  SUBSCRIPTION_RENEWAL: 'subscription_renewal',  // 订阅续费
  LIFETIME_MONTHLY: 'lifetime_monthly',   // 终身会员月度
  CREDIT_PACK: 'credit_pack',             // 积分包购买
  ADMIN_ADJUST: 'admin_adjust',           // 管理员调整
  REDEMPTION: 'redemption',               // 兑换码兑换
};
```

---

## 五、业务核心表

### 5.1 note_project（笔记项目表）

```sql
CREATE TABLE "note_project" (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  title TEXT,                    -- 项目标题（广场用）
  input_text TEXT NOT NULL,      -- 用户输入的原始文本
  language TEXT NOT NULL DEFAULT 'en',      -- 语言：en/zh
  visual_style TEXT NOT NULL DEFAULT 'sketch',  -- 视觉风格
  generate_mode TEXT NOT NULL DEFAULT 'detailed',  -- 生成模式
  signature TEXT DEFAULT '娇姐手绘整理',    -- 署名
  status TEXT NOT NULL DEFAULT 'draft',     -- 状态
  error_message TEXT,            -- 错误信息

  -- 广场相关字段
  is_public BOOLEAN NOT NULL DEFAULT FALSE,
  is_featured BOOLEAN NOT NULL DEFAULT FALSE,
  slug TEXT UNIQUE,              -- URL slug
  description TEXT,              -- 简短描述
  tags TEXT,                     -- 标签（逗号分隔）
  likes INTEGER NOT NULL DEFAULT 0,
  views INTEGER NOT NULL DEFAULT 0,
  published_at TIMESTAMP,

  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX note_project_user_id_idx ON "note_project"(user_id);
CREATE INDEX note_project_status_idx ON "note_project"(status);
CREATE INDEX note_project_created_at_idx ON "note_project"(created_at);
CREATE INDEX note_project_public_idx ON "note_project"(is_public);
CREATE INDEX note_project_style_idx ON "note_project"(visual_style);
```

| 字段 | 类型 | 可选值 | 说明 |
|------|------|--------|------|
| language | TEXT | 'en' / 'zh' | 图片文字语言 |
| visual_style | TEXT | 'sketch' / 'business' / 'cute' / 'minimal' / 'chalkboard' | 视觉风格 |
| generate_mode | TEXT | 'compact' / 'detailed' | 生成模式 |
| status | TEXT | 'draft' / 'processing' / 'completed' / 'failed' | 项目状态 |

### 5.2 note_card（笔记卡片表）

```sql
CREATE TABLE "note_card" (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL REFERENCES "note_project"(id) ON DELETE CASCADE,
  "order" INTEGER NOT NULL DEFAULT 0,    -- 排序序号
  original_text TEXT,            -- 原始文本片段
  structure TEXT,                -- JSON: LeftBrainData 结构化数据
  prompt TEXT,                   -- 生成图片的完整Prompt
  image_url TEXT,                -- 生成的图片URL
  status TEXT NOT NULL DEFAULT 'pending',
  error_message TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX note_card_project_id_idx ON "note_card"(project_id);
CREATE INDEX note_card_status_idx ON "note_card"(status);
CREATE INDEX note_card_order_idx ON "note_card"("order");
```

| 字段 | 类型 | 说明 |
|------|------|------|
| structure | TEXT | JSON字符串，存储LeftBrainData结构 |
| prompt | TEXT | 完整的图像生成Prompt |
| status | TEXT | 'pending' / 'generating' / 'completed' / 'failed' |

**structure 字段 JSON 结构：**

```json
{
  "title": "RAG检索增强生成",
  "summary_context": "将检索与生成结合，提升回答准确性",
  "visual_theme_keywords": "AI, 技术, 流程图",
  "modules": [
    {
      "id": "1",
      "heading": "检索阶段",
      "content": "从知识库中检索相关文档片段",
      "keywords": ["语义匹配", "文档检索", "知识库"]
    }
  ]
}
```

---

## 六、兑换码相关表

### 6.1 redemption_code（兑换码表）

```sql
CREATE TABLE "redemption_code" (
  id TEXT PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,     -- 兑换码格式：NOTEDRAW-XXXX-XXXX
  type TEXT NOT NULL,            -- 类型
  value INTEGER NOT NULL,        -- 积分数量或天数
  description TEXT,              -- 内部备注
  max_uses INTEGER NOT NULL DEFAULT 1,
  used_count INTEGER NOT NULL DEFAULT 0,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  expires_at TIMESTAMP,          -- null=永不过期
  created_by TEXT,               -- 创建者ID
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX redemption_code_idx ON "redemption_code"(code);
CREATE INDEX redemption_code_type_idx ON "redemption_code"(type);
CREATE INDEX redemption_code_active_idx ON "redemption_code"(is_active);
```

| 字段 | 类型 | 可选值 | 说明 |
|------|------|--------|------|
| type | TEXT | 'credits' / 'membership' / 'trial' | 类型 |
| value | INTEGER | - | credits时为积分数，其他为天数 |

### 6.2 redemption_record（兑换记录表）

```sql
CREATE TABLE "redemption_record" (
  id TEXT PRIMARY KEY,
  code_id TEXT NOT NULL REFERENCES "redemption_code"(id),
  user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  code TEXT NOT NULL,            -- 冗余存储兑换码
  type TEXT NOT NULL,            -- 冗余存储类型
  value INTEGER NOT NULL,        -- 冗余存储值
  redeemed_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX redemption_record_code_id_idx ON "redemption_record"(code_id);
CREATE INDEX redemption_record_user_id_idx ON "redemption_record"(user_id);
```

---

## 七、实体关系图（ERD）

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    user     │──1:N──│   session   │       │   account   │
│             │       └─────────────┘       │             │
│             │──────────────────────────1:N──────────────│
│             │       ┌─────────────┐       └─────────────┘
│             │──1:N──│   payment   │
│             │       └─────────────┘
│             │       ┌─────────────┐
│             │──1:1──│ user_credit │
│             │       └─────────────┘
│             │       ┌─────────────────────┐
│             │──1:N──│ credit_transaction  │
│             │       └─────────────────────┘
│             │       ┌─────────────────────┐
│             │──1:N──│    note_project     │──1:N──┬──────────────┐
│             │       └─────────────────────┘       │  note_card   │
│             │                                      └──────────────┘
│             │       ┌─────────────────────┐
│             │──1:N──│ redemption_record   │──N:1──┬──────────────────┐
└─────────────┘       └─────────────────────┘       │ redemption_code  │
                                                     └──────────────────┘
```

---

## 八、级联删除规则

| 主表 | 从表 | 规则 |
|------|------|------|
| user | session | CASCADE |
| user | account | CASCADE |
| user | payment | CASCADE |
| user | user_credit | CASCADE |
| user | credit_transaction | CASCADE |
| user | note_project | CASCADE |
| user | redemption_record | CASCADE |
| note_project | note_card | CASCADE |

---

## 九、索引策略

### 高频查询索引
- user.id, user.email, user.customer_id
- payment.user_id, payment.status, payment.subscription_id
- note_project.user_id, note_project.status, note_project.is_public
- note_card.project_id, note_card.status

### 范围查询索引
- note_project.created_at
- credit_transaction.created_at, credit_transaction.expiration_date

### 唯一约束索引
- user.email
- payment.invoice_id
- note_project.slug
- redemption_code.code

---

## 十、数据迁移命令

```bash
# 生成迁移文件
pnpm db:generate

# 执行迁移
pnpm db:migrate

# 直接推送schema（开发用）
pnpm db:push

# 打开Studio查看数据
pnpm db:studio
```
