# NoteDraw 核心业务描述

> 纯业务逻辑，不包含支付、数据库、登录认证等基础设施

## 一句话描述

**把一段文字变成一张好看的手绘风格知识卡片图**

---

## 核心业务流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户输入                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • 直接粘贴文字（最常用）                                          │   │
│  │  • 输入网页URL → 自动提取正文                                      │   │
│  │  • 上传文件 → 解析内容（未完全实现）                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       Step 1: 文本分析 (Organizer)                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  输入: "RAG是一种检索增强生成技术，它先从知识库检索..."              │   │
│  │                                                                   │   │
│  │  AI分析后输出:                                                    │   │
│  │  {                                                                │   │
│  │    知识点数量: 3                                                   │   │
│  │    卡片: [{                                                       │   │
│  │      标题: "RAG检索增强生成",                                      │   │
│  │      模块: [                                                      │   │
│  │        { 标题: "检索阶段", 关键词: ["检索文档","语义匹配"] },        │   │
│  │        { 标题: "增强阶段", 关键词: ["上下文注入","提示增强"] },      │   │
│  │        { 标题: "生成阶段", 关键词: ["准确回答","减少幻觉"] }         │   │
│  │      ]                                                            │   │
│  │    }]                                                             │   │
│  │  }                                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       Step 2: Prompt构建 (Designer)                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  根据「结构化数据 + 视觉风格」生成图像Prompt                         │   │
│  │                                                                   │   │
│  │  风格: sketch (手绘)                                              │   │
│  │  ↓                                                                │   │
│  │  "Create a hand-drawn visual note with title 'RAG检索增强生成',    │   │
│  │   3 sections with icons, sketch style, warm beige background,     │   │
│  │   visible pen strokes, signature '娇姐手绘整理' at bottom-right"   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       Step 3: 图像生成 (Painter)                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  调用图像生成API (Gemini / GPT-4o)                                │   │
│  │  ↓                                                                │   │
│  │  返回图片URL                                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户操作结果                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  • 预览生成的图片                                                  │   │
│  │  • 下载图片                                                       │   │
│  │  • 不满意 → 重新生成（消耗积分）                                    │   │
│  │  • 编辑Prompt → 自定义重新生成                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 核心业务概念

| 概念 | 说明 | 代码位置 |
|------|------|----------|
| **Project** | 一次生成任务，包含输入文本和配置 | `noteProject` 表 |
| **Card** | 生成的单张图片及其元数据 | `noteCard` 表 |
| **Structure** | AI分析后的结构化知识点数据 | `LeftBrainData` 类型 |
| **Prompt** | 发给图像API的指令 | `RightBrainData` 类型 |

---

## 用户可配置项

```
┌─────────────────────────────────────────────────────────────────┐
│  生成模式                                                        │
│  ├── 精简模式: 强制只生成1张图，最多4个知识点                       │
│  └── 详细模式: 根据知识点数量自动拆分成多张图                       │
├─────────────────────────────────────────────────────────────────┤
│  视觉风格                                                        │
│  ├── sketch    手绘草图（默认，最受欢迎）                          │
│  ├── business  商务专业                                          │
│  ├── cute      可爱卡通                                          │
│  ├── minimal   极简主义                                          │
│  └── chalkboard 黑板粉笔                                         │
├─────────────────────────────────────────────────────────────────┤
│  图片语言                                                        │
│  ├── zh  中文（图片上的文字用中文）                                │
│  └── en  英文                                                    │
├─────────────────────────────────────────────────────────────────┤
│  署名                                                            │
│  └── 自定义文字，显示在图片右下角（默认"娇姐手绘整理"）              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 业务规则

```typescript
// 1. 文本长度限制
MIN_INPUT_LENGTH: 10      // 太短无法分析
MAX_INPUT_LENGTH: 10000   // 太长影响质量

// 2. 卡片规则
MAX_SECTIONS_PER_CARD: 4  // 每张图最多4个知识模块
// 知识点 ≤ 4 → 1张图
// 知识点 > 4 → 多张图

// 3. 重新生成
// - 可以用原Prompt重新生成（换个效果）
// - 可以自定义Prompt重新生成（完全控制）
```

---

## 核心代码文件

```
src/ai/notedraw/
├── index.ts      # 主入口 generate() 函数
├── organizer.ts  # 文本分析，调用GLM
├── designer.ts   # Prompt构建
├── painter.ts    # 图像生成，调用Gemini/GPT-4o
├── prompts.ts    # Prompt模板
├── styles.ts     # 5种视觉风格配置
└── types.ts      # 类型定义

src/components/notedraw/
├── NoteDrawApp.tsx    # 主界面
├── ContentArea.tsx    # 输入区域（文本/URL/文件）
├── StyleSelector.tsx  # 风格选择器
├── ModeSelector.tsx   # 模式选择器
├── ResultGallery.tsx  # 结果展示
└── Workbench.tsx      # 进度显示
```

---

## 一图总结

```
┌────────────┐      ┌────────────┐      ┌────────────┐      ┌────────────┐
│   文字     │ ───▶ │  AI分析    │ ───▶ │  构建指令   │ ───▶ │  生成图片   │
│            │      │  提取知识点 │      │            │      │            │
└────────────┘      └────────────┘      └────────────┘      └────────────┘
     输入              Organizer          Designer            Painter
                       (GLM)                                 (Gemini)
```

**本质就是：文字 → 结构化 → 图片**

---

## 三个核心Agent

### 1. Organizer (拆解Agent)
- **职责**: 分析文本，提取知识点，决定生成几张图
- **输入**: 用户原始文本
- **输出**: 结构化的知识点数据 (LeftBrainData)
- **依赖**: 智谱 GLM-4-Flash API

### 2. Designer (设计Agent)
- **职责**: 将结构化数据转换为图像生成Prompt
- **输入**: LeftBrainData + 视觉风格
- **输出**: 图像Prompt (RightBrainData)
- **依赖**: 无外部依赖，纯逻辑处理

### 3. Painter (绘图Agent)
- **职责**: 调用图像API生成最终图片
- **输入**: Prompt + 图像配置
- **输出**: 图片URL
- **依赖**: Gemini / GPT-4o / apimart 图像API
